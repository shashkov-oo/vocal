<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1325" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Vocal Trainer</title>
  <style>
    :root {
      --bg:#0b1325; --bg2:#0f172a; --fg:#e5e7eb; --muted:#9aa3b2;
      --brand:#22c55e; --accent:#38bdf8; --danger:#ef4444; --stroke:#1f2937;
      --radius:16px; --tap:56px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;background:var(--bg);color:var(--fg)}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #0b1325 0%, #0a0f1a 45%, #080d16 100%);
    }
    .app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto;padding-bottom:calc(env(safe-area-inset-bottom))}
    .topbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(8px);
      background:color-mix(in oklab,var(--bg2) 70%,transparent);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      padding:12px 16px;border-bottom:1px solid var(--stroke)
    }
    .title{font-weight:800;letter-spacing:-0.02em;font-size:18px}
    .ghost{
      height:var(--tap);padding:0 16px;border-radius:12px;
      background:var(--bg2);border:1px solid var(--stroke);color:var(--fg);
      display:inline-flex;align-items:center;gap:8px;font-weight:600
    }
    .ghost:disabled{opacity:.5}
    .content{padding:12px 12px 96px;max-width:780px;margin:0 auto;width:100%}
    .panel{background:color-mix(in oklab,var(--bg2) 92%,transparent);border:1px solid var(--stroke);border-radius:var(--radius);padding:12px;margin-bottom:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width:680px){.row{gap:12px}}
    label{font-size:12px;color:var(--muted);margin:2px 2px 6px;display:block}
    select,input[type=number]{width:100%;background:var(--bg2);color:var(--fg);border:1px solid var(--stroke);border-radius:12px;height:var(--tap);padding:0 12px;font-size:16px}
    .seg{display:flex;background:var(--bg2);border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .seg button{flex:1;height:var(--tap);border:0;background:transparent;color:var(--fg);font-weight:700}
    .seg button.active{background:#152036}
    .graph{border-radius:var(--radius);border:1px solid var(--stroke);overflow:hidden;background:var(--bg2)}
    svg path{stroke:var(--accent);stroke-width:3;fill:none}
    .gridline{stroke:#334155;stroke-dasharray:4 6}
    .player{
      position:fixed;left:0;right:0;bottom:0;z-index:20;
      padding:10px 12px calc(env(safe-area-inset-bottom) + 10px);
      backdrop-filter:blur(10px);
      background:color-mix(in oklab,var(--bg2) 75%,transparent);
      border-top:1px solid var(--stroke);
      display:grid;grid-template-columns:1fr auto auto;gap:10px
    }
    .play{height:calc(var(--tap) + 8px);border-radius:16px;border:0;background:var(--brand);color:#0b1220;font-weight:900;font-size:18px}
    .pause,.stop{width:calc(var(--tap) + 8px);height:calc(var(--tap) + 8px);border-radius:16px;border:0;font-weight:900}
    .pause{background:#1f2937;color:#e5e7eb}
    .stop{background:var(--danger);color:#0b1220}
    details{border-radius:12px;overflow:hidden}
    summary{list-style:none;cursor:pointer;height:var(--tap);display:flex;align-items:center;gap:10px;padding:0 4px;font-weight:700}
    summary::-webkit-details-marker{display:none}
    .hint{font-size:11px;color:var(--muted)}
    .chip{border:1px solid var(--stroke);background:var(--bg2);color:var(--muted);border-radius:999px;padding:4px 8px;font-size:11px}
  </style>
</head>
<body>
<div class="app">
  <header class="topbar">
    <div class="title">Vocal Trainer</div>
    <div style="display:flex;gap:8px">
      <button id="btnInstall" class="ghost" hidden>Установить</button>
      <span id="soundStatus" class="chip">Пианино</span>
    </div>
  </header>

  <main class="content">
    <!-- Graph -->
    <div class="panel graph">
      <svg id="svg" width="800" height="220" viewBox="0 0 800 220"></svg>
    </div>

    <!-- Quick Controls -->
    <div class="panel">
      <div class="row">
        <div>
          <label>Старт</label>
          <select id="startNote"></select>
        </div>
        <div>
          <label>Паттерн</label>
          <select id="patternSelect"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>BPM</label>
          <input type="number" id="bpm" min="30" max="240" value="90" />
        </div>
        <div>
          <label>Длительность по умолчанию</label>
          <select id="noteDur">
            <option value="16n">1/16</option>
            <option value="8n" selected>1/8</option>
            <option value="4n">1/4</option>
            <option value="2n">1/2</option>
            <option value="1n">1</option>
            <option value="1n*2">2</option>
            <option value="1n*4">4</option>
          </select>
        </div>
      </div>
      <details style="margin-top:10px">
        <summary>Ещё · диапазон/шаг, направление, прелюдия</summary>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Повторов с шагом</label>
            <input type="number" id="repeatSteps" min="0" max="48" value="0" />
            <div class="hint">Сколько раз транспонировать</div>
          </div>
          <div>
            <label>Шаг (полутонов)</label>
            <input type="number" id="stepSemis" min="-12" max="12" value="1" />
            <div class="hint">По умолчанию: 1</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Пауза на вдох (мс)</label>
            <input type="number" id="breathMs" min="0" max="8000" value="800" />
          </div>
          <div>
            <label>Прелюдия</label>
            <select id="cueMode">
              <option value="none">Нет</option>
              <option value="chord" selected>Аккорд I</option>
              <option value="arp">Арпеджио</option>
              <option value="scale">Гамма</option>
            </select>
          </div>
        </div>
        <div style="margin-top:10px">
          <label>Направление</label>
          <div class="seg" role="radiogroup" aria-label="Направление">
            <button id="dirUp"   class="active" aria-pressed="true">Вверх</button>
            <button id="dirDown"                aria-pressed="false">Вниз</button>
          </div>
        </div>
      </details>
    </div>
  </main>

  <!-- Bottom Player -->
  <footer class="player">
    <button id="btnPlay"  class="play">▶️ Проиграть</button>
    <button id="btnPause" class="pause" disabled>⏸ Пауза</button>
    <button id="btnStop"  class="stop"  disabled>⏹</button>
  </footer>
</div>

<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
<script>
/* ========== Utils ========== */
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NAME_TO_SEMITONE = Object.fromEntries(NOTE_NAMES.map((n,i)=>[n,i]));
function noteToMidiSafe(note){
  const raw = String(note);
  const s = raw.trim().replace(/♯/g, "#").replace(/♭/g, "b");
  const m = /^([A-Ga-g])([#b]?)(-?\\d+)$/.exec(s);
  if(!m){ console.warn("PARSE_FAIL", raw); return 60; }
  let name = m[1].toUpperCase(), acc=m[2], oct=parseInt(m[3],10);
  const flats = { "Cb":"B","Db":"C#","Eb":"D#","Fb":"E","Gb":"F#","Ab":"G#","Bb":"A#" };
  if(acc==="b") name = flats[name+"b"] || (name+"b"); else if(acc==="#") name = name+"#";
  const idx = NAME_TO_SEMITONE[name]; if(idx===undefined) return 60;
  return idx + (oct+1)*12;
}
function midiToNote(m){ const name = NOTE_NAMES[((m%12)+12)%12]; const oct = Math.floor(m/12)-1; return name+oct; }
function durToSeconds(s){
  if(String(s).includes("*")){ const [b,k]=String(s).split("*"); return Tone.Time(b.trim()).toSeconds()*parseFloat(k); }
  return Tone.Time(s).toSeconds();
}
const MAJOR_STEPS=[0,2,4,5,7,9,11];
const degMajor = (n)=>MAJOR_STEPS[((n-1)%7+7)%7]+12*Math.floor((n-1)/7);

/* ========== Patterns (durSeq поддерживается) ========== */
const PATTERNS = [
  { id:"deg_arp", name:"Арпеджио 1–3–5–8–5–3–1", type:"degree", data:[1,3,5,8,5,3,1], desc:"" },
  { id:"deg_arp_long_top", name:"Арпеджио (длинная вершина)", type:"degree",
    data:[1,3,5,8,5,3,1], durSeq:["8n","8n","8n","1n","8n","8n","8n"], desc:"" },
  { id:"sem_canonical_1p5", name:"Каноничное 1.5", type:"semitone",
    data:[0,4,7,12,16,19,17,14,11,7,5,2,0], desc:"" },
  { id:"sem_canonical_1p5_long_apex", name:"Каноничное 1.5 (длинная вершина)", type:"semitone",
    data:[0,4,7,12,16,19,17,14,11,7,5,2,0],
    durSeq:["8n","8n","8n","8n","8n","1n","8n","8n","8n","8n","8n","8n","8n"], desc:"" },
];

function getDurSeqForBlock(pattern, fallbackDur, length){
  if(pattern.durSeq && pattern.durSeq.length){
    const seq = pattern.durSeq.slice(0,length);
    while(seq.length<length) seq.push(fallbackDur);
    return seq;
  }
  return Array.from({length}, ()=>fallbackDur);
}

/* ========== Elements & State ========== */
const els = {
  svg: document.getElementById("svg"),
  startNote: document.getElementById("startNote"),
  patternSelect: document.getElementById("patternSelect"),
  bpm: document.getElementById("bpm"),
  noteDur: document.getElementById("noteDur"),
  repeatSteps: document.getElementById("repeatSteps"),
  stepSemis: document.getElementById("stepSemis"),
  breathMs: document.getElementById("breathMs"),
  cueMode: document.getElementById("cueMode"),
  dirUp: document.getElementById("dirUp"),
  dirDown: document.getElementById("dirDown"),
  btnPlay: document.getElementById("btnPlay"),
  btnPause: document.getElementById("btnPause"),
  btnStop: document.getElementById("btnStop"),
  btnInstall: document.getElementById("btnInstall"),
  soundStatus: document.getElementById("soundStatus"),
};
let dir = "up";
let isPaused = false;

/* ========== Fill Controls ========== */
function fillNotes(){
  const items=[];
  for(let o=2;o<=6;o++){ for(const n of NOTE_NAMES){ items.push(`${n}${o}`);} }
  for(const n of items){ const opt=document.createElement("option"); opt.value=n; opt.textContent=n; els.startNote.appendChild(opt); }
  els.startNote.value="C3";
}
function fillPatterns(){
  for(const p of PATTERNS){ const opt=document.createElement("option"); opt.value=p.id; opt.textContent=p.name; els.patternSelect.appendChild(opt); }
  els.patternSelect.value="sem_canonical_1p5_long_apex";
}
fillNotes(); fillPatterns();

/* ========== Compute & Graph (с реальными длительностями) ========== */
function buildPatternSeq(startMidi, pattern){
  const rel = (pattern.type==="degree") ? pattern.data.map(d=>degMajor(d)) : pattern.data.slice();
  return rel.map(off=>startMidi+off);
}
function drawGraphFromBlocks(blocks, dursBlocks, breathGapSec){
  const points=[]; let t=0;
  for(let b=0;b<blocks.length;b++){
    const blk=blocks[b], durs=dursBlocks[b];
    for(let i=0;i<blk.length;i++){ points.push({x:t,y:blk[i]}); t += durToSeconds(durs[i]); }
    t += breathGapSec;
  }
  const totalSec = points.length ? points[points.length-1].x : 0.1;
  const pxPerSec = 120;
  const width = Math.max(360, Math.ceil(totalSec*pxPerSec)+40), height=220;
  els.svg.setAttribute("width", width); els.svg.setAttribute("viewBox", `0 0 ${width} ${height}`); els.svg.innerHTML="";
  const bg=document.createElementNS("http://www.w3.org/2000/svg","rect");
  bg.setAttribute("x","0");bg.setAttribute("y","0");bg.setAttribute("width",width);bg.setAttribute("height",height);bg.setAttribute("fill","#0f172a");els.svg.appendChild(bg);
  for(let i=1;i<=6;i++){ const line=document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1","0");line.setAttribute("x2",String(width));
    line.setAttribute("y1",String(i*30));line.setAttribute("y2",String(i*30));
    line.setAttribute("class","gridline");els.svg.appendChild(line);
  }
  if(!points.length) return;
  const minY=Math.min(...points.map(p=>p.y)), maxY=Math.max(...points.map(p=>p.y));
  const scaleX=(sec)=>sec*pxPerSec+10;
  const scaleY=(midi)=> height - ((midi-minY)/Math.max(1,(maxY-minY)))*(height-20) - 10;
  let d=""; points.forEach((p,i)=>{ const x=scaleX(p.x), y=scaleY(p.y); d+=(i===0?"M":"L")+x.toFixed(2)+","+y.toFixed(2)+" "; });
  const path=document.createElementNS("http://www.w3.org/2000/svg","path"); path.setAttribute("d",d.trim()); els.svg.appendChild(path);
}
function computeAll(){
  const bpm=parseInt(els.bpm.value||"90",10); Tone.Transport.bpm.value=bpm;
  const pattern=PATTERNS.find(p=>p.id===els.patternSelect.value);
  const noteDurStr=els.noteDur.value;
  const startMidi=noteToMidiSafe(els.startNote.value);
  const repeatSteps=Math.max(0,Math.min(48,parseInt(els.repeatSteps.value||"0",10)));
  const stepSemis=parseInt(els.stepSemis.value||"0",10);
  const breathGapSec=Math.max(0,parseInt(els.breathMs.value||"0",10))/1000;

  const blocks=[], dursBlocks=[];
  for(let i=0;i<=repeatSteps;i++){
    const base = startMidi + i*stepSemis;
    const seq  = buildPatternSeq(base, pattern);
    const dseq = getDurSeqForBlock(pattern, noteDurStr, seq.length);
    blocks.push(dir==="down" ? seq.slice().reverse() : seq);
    dursBlocks.push(dir==="down" ? dseq.slice().reverse() : dseq);
  }
  drawGraphFromBlocks(blocks, dursBlocks, breathGapSec);
  return {blocks, dursBlocks, startMidi, stepSemis, breathGapSec, pattern, noteDurStr};
}

/* ========== Audio: Piano Sampler (singleton) ========== */
let piano=null, pianoLoading=null, current=null;
async function getPiano(){
  if(piano) return piano;
  if(pianoLoading) return pianoLoading;
  els.soundStatus.textContent="Загрузка…";
  pianoLoading=new Promise((resolve,reject)=>{
    const s=new Tone.Sampler({
      urls:{
        A0:"A0.mp3",
        C1:"C1.mp3","D#1":"Ds1.mp3","F#1":"Fs1.mp3",A1:"A1.mp3",
        C2:"C2.mp3","D#2":"Ds2.mp3","F#2":"Fs2.mp3",A2:"A2.mp3",
        C3:"C3.mp3","D#3":"Ds3.mp3","F#3":"Fs3.mp3",A3:"A3.mp3",
        C4:"C4.mp3","D#4":"Ds4.mp3","F#4":"Fs4.mp3",A4:"A4.mp3",
        C5:"C5.mp3","D#5":"Ds5.mp3","F#5":"Fs5.mp3",A5:"A5.mp3",
        C6:"C6.mp3","D#6":"Ds6.mp3","F#6":"Fs6.mp3",A6:"A6.mp3",
        C7:"C7.mp3","D#7":"Ds7.mp3","F#7":"Fs7.mp3",A7:"A7.mp3",
        C8:"C8.mp3"
      },
      baseUrl:"./salamander/",
      attack:0.001, release:1.2,
      onload:()=>{piano=s;els.soundStatus.textContent="Пианино";resolve(piano)},
      onerror:(e)=>{els.soundStatus.textContent="Ошибка загрузки";reject(e)}
    }).toDestination();
  });
  return pianoLoading;
}
async function ensureAudio(){ await getPiano(); await Tone.start(); current=piano; return current; }
function stopPlayback(){
  Tone.Transport.stop(); Tone.Transport.cancel();
  if(current?.releaseAll){ try{ current.releaseAll(); }catch(e){} }
  isPaused=false;
  els.btnPlay.disabled=false;
  els.btnPause.disabled=true; els.btnPause.textContent="⏸ Пауза";
  els.btnStop.disabled=true;
}

/* ========== Cue (прелюдия) ========== */
const CUE = {
  none:()=>[],
  chord:(root)=>[{notes:[0,4,7].map(s=>root+s),dur:"4n"}],
  arp:(root)=>[0,4,7,12].map(s=>({notes:[root+s],dur:"8n"})),
  scale:(root)=>[1,2,3,4,5,4,3,2,1].map(d=>({notes:[root+degMajor(d)],dur:"8n"})),
};
function scheduleCue(startWhen, rootMidi){
  const mode=els.cueMode.value; if(mode==="none") return startWhen;
  const steps=CUE[mode](rootMidi); let acc=startWhen;
  for(const step of steps){
    Tone.Transport.schedule((t)=>{
      if(step.notes.length>1){ step.notes.forEach(n=>current.triggerAttackRelease(midiToNote(n), step.dur, t, 0.9)); }
      else{ current.triggerAttackRelease(midiToNote(step.notes[0]), step.dur, t, 0.9); }
    }, `+${acc}`);
    acc += Tone.Time(step.dur).toSeconds();
  }
  return acc + 0.06;
}

/* ========== Playback (Play / Pause / Stop) ========== */
els.btnPlay.addEventListener("click", async ()=>{
  // Если на паузе — просто продолжим
  if(isPaused){ Tone.Transport.start(); isPaused=false; els.btnPause.textContent="⏸ Пауза"; return; }

  await ensureAudio();
  stopPlayback(); // чистый старт
  els.btnPlay.disabled=true; els.btnPause.disabled=false; els.btnStop.disabled=false;

  // sync bpm
  Tone.Transport.bpm.value = parseInt(els.bpm.value||"90",10);

  const {blocks, dursBlocks, startMidi, breathGapSec} = computeAll();
  let when = 0;
  // schedule per block
  for(let b=0;b<blocks.length;b++){
    const block=blocks[b], dseq=dursBlocks[b];
    const blockRoot = startMidi + b*parseInt(els.stepSemis.value||"0",10);
    when = scheduleCue(when, blockRoot);
    for(let i=0;i<block.length;i++){
      const midi = block[i], durStr = dseq[i];
      const dSec = durToSeconds(durStr);
      Tone.Transport.schedule((t)=>{ current.triggerAttackRelease(midiToNote(midi), durStr, t, 0.9); }, `+${when}`);
      when += dSec;
    }
    when += breathGapSec;
  }
  Tone.Transport.scheduleOnce(()=>{ stopPlayback(); }, `+${when + 0.08}`);
  Tone.Transport.start();
});

els.btnPause.addEventListener("click", ()=>{
  if(els.btnPause.disabled) return;
  if(!isPaused){ Tone.Transport.pause(); isPaused=true; els.btnPause.textContent="▶️ Продолжить"; }
  else { Tone.Transport.start(); isPaused=false; els.btnPause.textContent="⏸ Пауза"; }
});

els.btnStop.addEventListener("click", stopPlayback);

/* ========== Reactive UI ========== */
function recompute(){ computeAll(); }
["patternSelect","startNote","bpm","noteDur","repeatSteps","stepSemis","breathMs","cueMode"]
  .forEach(id=>document.getElementById(id).addEventListener("change", recompute));
els.dirUp.addEventListener("click",()=>{dir="up";els.dirUp.classList.add("active");els.dirDown.classList.remove("active");recompute();});
els.dirDown.addEventListener("click",()=>{dir="down";els.dirDown.classList.add("active");els.dirUp.classList.remove("active");recompute();});

/* ========== PWA Install Prompt ========== */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); deferredPrompt=e; els.btnInstall.hidden=false; });
els.btnInstall.addEventListener("click", async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; els.btnInstall.hidden=true;
});

/* ========== Init ========== */
computeAll();
getPiano().catch(()=>{});
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js").catch(()=>{}); }
</script>
</body>
</html>
